---
title: Messaggi, payload e serializzazione del bus di servizio di Azure | Microsoft Docs
description: Questo articolo offre una panoramica dei bus di servizio di Azure, dei payload, del routing dei messaggi e della serializzazione.
ms.topic: article
ms.date: 04/14/2021
ms.openlocfilehash: 2ed65054f61aee4b9fb6157fc7a36e469c7a672c
ms.sourcegitcommit: db925ea0af071d2c81b7f0ae89464214f8167505
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/15/2021
ms.locfileid: "107515295"
---
# <a name="messages-payloads-and-serialization"></a>Messaggi, payload e serializzazione

Il bus di servizio di Microsoft Azure gestisce i messaggi. I messaggi trasportano un payload e metadati. I metadati sono sotto forma di proprietà della coppia chiave-valore e descrivono il payload e fornisce istruzioni di gestione per il bus di servizio e le applicazioni. In alcuni casi i soli metadati sono sufficienti per includere le informazioni che il mittente vuole comunicare ai ricevitori e il payload rimane vuoto.

Il modello a oggetti dei client ufficiali del bus di servizio per .NET e Java riflette la struttura astratta dei messaggi del bus di servizio, che viene mappata verso e dai protocolli di rete supportati dal bus di servizio.
 
Un messaggio del bus di servizio è costituito da una sezione di paylod binario che non viene mai gestita in alcun modo dal bus di servizio sul lato server e da due set di proprietà. Le *proprietà del broker* sono predefinite dal sistema. Queste proprietà predefinite controllano le funzionalità a livello di messaggio all'interno del broker oppure sono mappate a elementi comuni e standardizzati dei metadati. Le *proprietà utente* sono una raccolta di coppie chiave-valore che possono essere definite e configurate dall'applicazione.
 
Le proprietà predefinite del broker sono elencate nella tabella seguente. I nomi vengono usati con tutte le API client ufficiali e anche nell'oggetto JSON [BrokerProperties](https://docs.microsoft.com/rest/api/servicebus/introduction) del mapping di protocolli HTTP.
 
I nomi equivalenti usati a livello del protocollo AMQP sono elencati tra parentesi. Anche se i nomi seguenti usano l'uso di maiuscole e minuscole pascal, si noti che i client JavaScript e Python userebbero rispettivamente l'uso di maiuscole e minuscole camel e python.

| Nome proprietà                         | Descrizione                                                                                                                                                                                                                                                                                                                                                                                                                               |
|---------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `ContentType` (content-type)           | Descrive facoltativamente il payload del messaggio, con un descrittore che segue il formato RFC2045, Sezione 5, ad esempio `application/json`.                                                                                                                                                                                                                                                                                             |
| `CorrelationId` (correlation-id)       | Consente a un'applicazione di specificare un contesto per il messaggio per finalità di correlazione, ad esempio rispecchiando il valore **MessageId** di un messaggio a cui si risponde.                                                                                                                                                                                                                                                                  |
| `DeadLetterSource`                      | Impostare solo nei messaggi che sono stati inviati senza messaggi non recapitati e successivamente inviati automaticamente dalla coda dei messaggi non recapitati a un'altra entità. Indica l'entità in cui il messaggio è stato impostato come non recapitabile. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                  |
| `DeliveryCount`                         | <p>Numero di tentativi di recapito per questo messaggio. Il numero viene incrementato allo scadere di un blocco di messaggio oppure quando il messaggio viene abbandonato esplicitamente dal ricevitore. Questa proprietà è di sola lettura.</p> <p>Il numero di recapito non viene incrementato quando la connessione AMQP sottostante viene chiusa.</p>                                                                                                                                                                                                                                                 |
| `EnqueuedSequenceNumber`                | Per i messaggi che sono stati inviati automaticamente, questa proprietà riflette il numero di sequenza assegnato per la prima volta al messaggio nel punto di invio originale. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                                                |
| `EnqueuedTimeUtc`                       | Istante UTC in cui il messaggio è stato accettato e archiviato nell'entità. Questo valore può essere usato come indicatore dell'ora di arrivo autorevole e neutra quando il ricevitore non vuole considerare attendibile l'orologio del mittente. Questa proprietà è di sola lettura.                                                                                                                                                                                                   |
| `ExpiresAtUtc` (absolute-expiry-time) | Istante UTC in cui il messaggio è contrassegnato per la rimozione e non è più disponibile per il recupero dall'entità a causa della scadenza. La scadenza viene controllata dalla proprietà **TimeToLive** e questa proprietà viene calcolata da EnqueuedTimeUtc+TimeToLive. Questa proprietà è di sola lettura.                                                                                                                                                                           |
| `Label` o `Subject` (oggetto)                       | Questa proprietà consente all'applicazione di indicare la finalità del messaggio al ricevitore in modo standardizzato, analogamente alla riga dell'oggetto del messaggio di posta elettronica.                                                                                                                                                                                                                                                                                  |
| `LockedUntilUtc`                        | Per i messaggi recuperati in caso di blocco (modalità di ricezione blocco di visualizzazione, non pre-finalizzati), questa proprietà rispecchia l'istante UTC di termine del blocco del messaggio nella coda/sottoscrizione. Alla scadenza del blocco, la proprietà [DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount) viene incrementata e il messaggio è di nuovo disponibile per il recupero. Questa proprietà è di sola lettura.                                                                                                                         |
| `LockToken`                             | Il token di blocco è un riferimento al blocco mantenuto dal broker nella modalità di ricezione *blocco di visualizzazione*. Il token può essere usato per aggiungere in modo permanente il blocco tramite l'API [Differimento](message-deferral.md) e quindi di estrarre il messaggio dal flusso normale dello stato di recapito. Questa proprietà è di sola lettura.                                                                                                                                                               |
| `MessageId` (message-id)                | Questo identificatore di messaggio è un valore definito dall'applicazione che identifica in modo univoco il messaggio e il rispettivo payload. L'identificatore è una stringa freeform e può rispecchiare un GUID o un identificatore derivato dal contesto dell'applicazione. Se abilitata, la funzionalità di [rilevamento duplicati](duplicate-detection.md) identifica e rimuove il secondo invio e gli invii successivi di messaggi con lo stesso valore **MessageId**.                                                                |
| `PartitionKey`                          | Per le [entità partizionate](service-bus-partitioning.md), la configurazione di questo valore consente di assegnare i messaggi correlati alla stessa partizione interna, in modo che l'ordine della sequenza di invio sia registrato correttamente. La partizione viene scelta da una funzione hash su questo valore e non può essere scelta direttamente. Per entità con riconoscimento della sessione, la proprietà **SessionId** esegue l'override di questo valore.                                                                                                       |
| `ReplyTo` (rispondi a)                    | Questo valore facoltativo e definito dall'applicazione è un modo standard per esprimere un percorso di risposta verso il ricevitore del messaggio. Quando un mittente si aspetta una risposta, imposta il valore sul percorso assoluto o relativo della coda o dell'argomento a cui si prevede che venga inviata la risposta.                                                                                                                                           |
| `ReplyToSessionId` (reply-to-group-id)  | Questo valore aumenta l'informazione **ReplyTo** e specifica quale valore **SessionId** deve essere impostato per la risposta in caso di invio all'entità di risposta.                                                                                                                                                                                                                                                                            |
| `ScheduledEnqueueTimeUtc`               | Per i messaggi che vengono resi disponibili solo per il recupero dopo un ritardo, questa proprietà definisce l'istante UTC in cui il messaggio verrà sottoposto logicamente ad accodamento e sequenziamento e verrà quindi reso disponibile per il recupero.                                                                                                                                                                                                                 |
| `SequenceNumber`                        | Il numero di sequenza è un numero intero univoco a 64 bit assegnato a un messaggio quando viene accettato e archiviato dal broker. Viene usato come identificatore effettivo del messaggio. Per le entità partizionate, i primi 16 bit rispecchiano l'identificatore della partizione. I numeri di sequenza vengono incrementati in modo progressivo costante e senza pause. Viene eseguito il rollover a 0 all'esaurimento dell'intervallo compreso tra 48 e 64 bit. Questa proprietà è di sola lettura.                                                                |
| `SessionId` (group-id)                  | Per le entità con riconoscimento della sessione, questo valore definito dall'applicazione specifica l'affiliazione di sessione del messaggio. I messaggi con lo stesso identificatore di sessione sono soggetti al blocco di riepilogo e consentono l'elaborazione esatta in ordine e il demultiplexing. Per le entità senza riconoscimento della sessione, questo valore viene ignorato.                                                                                                                                     |
                                                                                                                                          |
| `TimeToLive`                            | Questo valore indica la durata relativa dopo cui il messaggio scade, a partire dall'istante in cui il messaggio è stato accettato e archiviato dal broker, in base a quanto acquisito in **EnqueueTimeUtc**. Se non è configurata in modo esplicito, il valore predefinito è il **DefaultTimeToLive** per la coda o l'argomento corrispondente. Un valore **TimeToLive** a livello di messaggio non può essere più lungo dell'impostazione **DefaultTimeToLive** dell'entità. Viene modificato automaticamente nel caso in cui sia superiore. |
| `To` (a)                               | Questa proprietà è riservata per l'uso futuro negli scenari di routing e viene attualmente ignorata dal broker. Le applicazioni possono usare questo valore negli scenari di concatenamento automatico basato su regole per indicare la destinazione logica desiderata del messaggio.                                                                                                                                                                                   |
| `ViaPartitionKey`                       | Se un messaggio viene inviato tramite una coda di trasferimento nell'ambito di una transazione, questo valore seleziona la partizione della coda di trasferimento.                                                                                                                                                                                                                                                                                                                 |

Il modello di messaggio astratto consente di inviare un messaggio a una coda tramite HTTPS e può essere recuperato tramite AMQP. In entrambi i casi, l'aspetto del messaggio è normale nel contesto del rispettivo protocollo. Le proprietà del broker vengono convertite in base alla necessità e le proprietà utente sono mappate alla posizione più appropriata nel rispettivo modello di messaggi relativo al protocollo. In HTTP le proprietà utente sono mappate direttamente verso e dalle intestazioni HTTP. In AMQP sono mappate verso e dalla mappa **applicazione-proprietà**.

## <a name="message-routing-and-correlation"></a>Routing e correlazione dei messaggi

Un subset delle proprietà del broker descritte in precedenza, in particolare , , , , e , vengono usati per consentire alle applicazioni di instradare i `To` `ReplyTo` messaggi a destinazioni `ReplyToSessionId` `MessageId` `CorrelationId` `SessionId` specifiche. Per illustrare questa funzionalità, prendere in considerazione alcuni modelli:

- **Semplice richiesta/risposta**: un'entità di pubblicazione invia un messaggio a una coda e si aspetta una risposta dal consumer di messaggi. Per ricevere la risposta, l'entità di pubblicazione è proprietaria di una coda in cui si aspetta che vengano recapitate le risposte. L'indirizzo di tale coda viene espresso nella proprietà **ReplyTo** del messaggio in uscita. Quando il consumer risponde, copia il valore **MessageId** del messaggio gestito nella proprietà **CorrelationId** del messaggio di risposta e recapita il messaggio alla destinazione indicata dalla proprietà **ReplyTo**. Un messaggio può ottenere più risposte, in base al contesto dell'applicazione.
- **Richiesta/Risposta multicast**: come variazione rispetto al modello precedente, un'entità di pubblicazione invia il messaggio in un argomento e più sottoscrittori risultano idonei all'utilizzo del messaggio. Ogni sottoscrittore può rispondere come illustrato in precedenza. Questo modello viene usato in scenari di individuazione o di verifica di presenze e l'intervistato si identifica in genere con una proprietà utente o all'interno del payload. Se **ReplyTo** fa riferimento a un argomento, tale set di risposte di individuazione può essere distribuito a un gruppo di destinatari.
- **Multiplexing**: questa funzionalità della sessione consente il multiplexing dei flussi di messaggi correlati tramite una singola coda o sottoscrizione, in modo che ogni sessione o gruppo di messaggi correlati, identificati da valori **SessionId** corrispondenti, venga indirizzato a un ricevitore specifico mentre il ricevitore applica un blocco alla sessione. Altre informazioni sui dettagli delle sessioni sono disponibili [qui](message-sessions.md).
- **Richiesta/Risposta con multiplexing**: questa funzionalità della sessione abilita le risposte con multiplexing, consentendo a diverse entità di pubblicazione di condividere una coda di risposte. Configurando il valore **ReplyToSessionId**, l'entità di pubblicazione può richiedere ai consumer di copiare tale valore nella proprietà **SessionId** del messaggio di risposta. La coda o l'argomento di pubblicazione non deve essere in grado di riconoscere la sessione. Quando il messaggio viene inviato, l'entità di pubblicazione può quindi attendere in modo specifico che nella coda si materializzi una sessione con il valore **SessionId** specificato, accettando in modo condizionale un ricevitore di sessione. 

Il routing all'interno di uno spazio dei nomi del bus di servizio può essere realizzato usando il concatenamento automatico e le regole di sottoscrizione dell'argomento. È possibile ottenere il routing tra spazi dei nomi tramite le [app per la logica di Azure](https://azure.microsoft.com/services/logic-apps/). Come indicato nell'esempio precedente, la proprietà **To** è riservata per l'uso futuro e potrebbe essere interpretata dal broker con una funzionalità abilitata in modo specifico. Le applicazioni che vogliono implementare il routing devono eseguire questa operazione in base alle proprietà utente e non basarsi sulla **proprietà A.** Tuttavia, questa operazione non causerà problemi di compatibilità.

## <a name="payload-serialization"></a>Serializzazione del payload

Durante il transito o l'archiviazione nel bus di servizio, il payload è sempre un blocco binario opaco. La proprietà consente alle applicazioni di descrivere il payload, con il formato suggerito per i valori della proprietà come descrizione del tipo di contenuto MIME in base `ContentType` a IETF RFC2045, ad esempio `application/json;charset=utf-8` .

A differenza delle varianti per Java o .NET Standard, la versione .NET Framework dell'API Bus di servizio supporta la creazione di istanze di **BrokeredMessage** tramite il passaggio di oggetti .NET arbitrari al costruttore. 

Quando si usa il protocollo SBMP legacy, questi oggetti vengono quindi serializzati con il serializzatore binario predefinito o con un serializzatore fornito esternamente. Quando si usa il protocollo AMQP, l'oggetto viene serializzato in un oggetto AMQP. Il ricevitore può recuperare quegli oggetti con il metodo [GetBody\<T>()](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.getbody#Microsoft_ServiceBus_Messaging_BrokeredMessage_GetBody__1), fornendo il tipo previsto. Con AMQP, gli oggetti vengono serializzati in un grafo AMQP di oggetti e e qualsiasi `ArrayList` `IDictionary<string,object>` client AMQP può decodificarli. 

Anche se questo approccio di serializzazione nascosta risulta utile, è consigliabile che le applicazioni abbiano il controllo esplicito della serializzazione degli oggetti e trasformino i grafici di oggetti in flussi prima di includerli in un messaggio e che l'operazione inversa venga eseguita sul lato del ricevitore. In questo modo si ottengono risultati interoperativi. Sebbene AMQP abbia un potente modello di codifica binaria, è associato all'ecosistema di messaggistica AMQP e i client HTTP avranno problemi a decodificare tali payload. 

Le varianti di API .NET Standard e Java accettano solo matrici di byte e quindi l'applicazione deve gestire il controllo della serializzazione degli oggetti. 

## <a name="next-steps"></a>Passaggi successivi

Per altre informazioni sulla messaggistica del bus di servizio, vedere gli argomenti seguenti:

* [Code, argomenti e sottoscrizioni del bus di servizio](service-bus-queues-topics-subscriptions.md)
* [Introduzione alle code del bus di servizio](service-bus-dotnet-get-started-with-queues.md)
* [Come usare gli argomenti e le sottoscrizioni del bus di servizio](service-bus-dotnet-how-to-use-topics-subscriptions.md)
